<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚˜ë§Œì˜ ì˜ì–´ë‹¨ì–´ í€´ì¦ˆ</title>
  <meta name="theme-color" content="#ffffff">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button, select {
      font-size: 18px;
      padding: 10px;
      width: 100%;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      box-sizing: border-box;
    }
    button {
      background: #4a8fff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #3a7fee;
    }
    .question {
      font-size: 22px;
      margin: 20px 0;
      font-weight: bold;
    }
    .result {
      margin-top: 20px;
      font-size: 18px;
      white-space: pre-line;
    }
    .nav-menu {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .nav-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background: #e8f4f8;
      color: #333;
      border: 2px solid #4a8fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s;
      display: block;
    }
    .nav-btn:hover {
      background: #4a8fff;
      color: white;
    }
    .nav-btn.active {
      background: #4a8fff;
      color: white;
    }
    .mode-selector {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .mode-btn {
      flex: 1;
      padding: 15px;
      background: #e0e0e0;
      color: #333;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .mode-btn:hover {
      background: #d0d0d0;
    }
    .mode-btn.active {
      background: #4a8fff;
      color: white;
      border-color: #4a8fff;
    }
    .test-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .test-table th {
      background: #4a8fff;
      color: white;
      padding: 10px;
      text-align: left;
      font-size: 16px;
    }
    .test-table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }
    .test-bookmark-btn {
      background: #ffc107;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
    }
    .test-bookmark-btn:hover {
      background: #e0a800;
    }
    .test-bookmark-btn.active {
      background: #ff9800;
    }
    .test-table input {
      width: 100%;
      padding: 5px;
      margin: 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .test-table input.correct {
      background: #d4edda;
      border-color: #28a745;
    }
    .test-table input.wrong {
      background: #f8d7da;
      border-color: #dc3545;
    }
    .score-display {
      font-size: 24px;
      font-weight: bold;
      color: #4a8fff;
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #f0f8ff;
      border-radius: 8px;
    }
    .answer-key {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .progress {
      margin: 10px 0;
      font-size: 16px;
      color: #666;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>ğŸ“˜ ë‚˜ë§Œì˜ ì˜ì–´ë‹¨ì–´ í€´ì¦ˆ</h2>

  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
  <div class="nav-menu">
    <a href="wordlist.html" class="nav-btn">ğŸ“š ì „ì²´ ë‹¨ì–´</a>
    <a href="bookmarks.html" class="nav-btn">â­ ì¦ê²¨ì°¾ê¸°</a>
    <a href="index.html" class="nav-btn active">ğŸ¯ í€´ì¦ˆ</a>
  </div>

  <!-- ëª¨ë“œ ì„ íƒ ë²„íŠ¼ -->
  <div class="mode-selector">
    <button class="mode-btn active" onclick="selectMode('quiz')" id="quizModeBtn">
      ğŸ¯ í€´ì¦ˆ ëª¨ë“œ
    </button>
    <button class="mode-btn" onclick="selectMode('test')" id="testModeBtn">
      ğŸ“ ì‹œí—˜ì§€ ëª¨ë“œ
    </button>
  </div>

  <!-- í€´ì¦ˆ ëª¨ë“œ ì„¤ì • -->
  <div id="quizSettings">
    <label>ë¬¸ì œ ìœ í˜• ì„ íƒ:</label>
    <select id="quizMode">
      <option value="mixed">í˜¼í•© (ì˜ì–´+í•œê¸€)</option>
      <option value="korean">í•œê¸€ ëœ»ë§Œ ë§ì¶”ê¸° (ì˜ì–´â†’í•œê¸€)</option>
      <option value="english">ì˜ì–´ ë‹¨ì–´ë§Œ ë§ì¶”ê¸° (í•œê¸€â†’ì˜ì–´)</option>
    </select>

    <label>ë‹¨ì–´ ì„ íƒ ë°©ì‹:</label>
    <select id="quizSelectMode" onchange="changeQuizSelectMode()">
      <option value="range">ë²”ìœ„ë¡œ ì„ íƒ</option>
      <option value="alphabet">ì•ŒíŒŒë²³ìœ¼ë¡œ ì„ íƒ</option>
    </select>

    <!-- ë²”ìœ„ ì„ íƒ -->
    <div id="quizRangeSelect">
      <label>ë‹¨ì–´ ë²”ìœ„ ì„ íƒ:</label>
      <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
        <input type="number" id="rangeStart" placeholder="ì‹œì‘" min="1" style="width: 80px;" value="1" />
        <span>~</span>
        <input type="number" id="rangeEnd" placeholder="ë" min="1" style="width: 80px;" />
        <button onclick="setFullRange()" style="width: auto; padding: 10px 15px; margin: 0;">ì „ì²´</button>
      </div>

      <label>ë¬¸ì œ ê°œìˆ˜ ì„ íƒ (ìµœëŒ€ 50):</label>
      <select id="quizCount">
        <option value="10">10ê°œ</option>
        <option value="20">20ê°œ</option>
        <option value="30">30ê°œ</option>
        <option value="40">40ê°œ</option>
        <option value="50">50ê°œ</option>
      </select>
    </div>

    <!-- ì•ŒíŒŒë²³ ì„ íƒ -->
    <div id="quizAlphabetSelect" style="display:none;">
      <label>ì‹œì‘ ì•ŒíŒŒë²³ ì„ íƒ:</label>
      <select id="alphabetFilter" style="margin-top: 10px;">
        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        <option value="a">A</option>
        <option value="b">B</option>
        <option value="c">C</option>
        <option value="d">D</option>
        <option value="e">E</option>
        <option value="f">F</option>
        <option value="g">G</option>
        <option value="h">H</option>
        <option value="i">I</option>
        <option value="j">J</option>
        <option value="k">K</option>
        <option value="l">L</option>
        <option value="m">M</option>
        <option value="n">N</option>
        <option value="o">O</option>
        <option value="p">P</option>
        <option value="q">Q</option>
        <option value="r">R</option>
        <option value="s">S</option>
        <option value="t">T</option>
        <option value="u">U</option>
        <option value="v">V</option>
        <option value="w">W</option>
        <option value="x">X</option>
        <option value="y">Y</option>
        <option value="z">Z</option>
      </select>
      <div id="alphabetCount" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
    </div>

    <button onclick="startQuiz()">í€´ì¦ˆ ì‹œì‘</button>
  </div>

  <!-- ì‹œí—˜ì§€ ëª¨ë“œ ì„¤ì • -->
  <div id="testSettings" style="display:none;">
    <label>ì‹œí—˜ì§€ ìœ í˜• ì„ íƒ:</label>
    <select id="testMode">
      <option value="mixed">í˜¼í•© (ì˜ì–´+í•œê¸€)</option>
      <option value="korean">í•œê¸€ ëœ»ë§Œ ë§ì¶”ê¸° (ì˜ì–´â†’í•œê¸€)</option>
      <option value="english">ì˜ì–´ ë‹¨ì–´ë§Œ ë§ì¶”ê¸° (í•œê¸€â†’ì˜ì–´)</option>
    </select>

    <label>ë‹¨ì–´ ì„ íƒ ë°©ì‹:</label>
    <select id="testSelectMode" onchange="changeTestSelectMode()">
      <option value="range">ë²”ìœ„ë¡œ ì„ íƒ</option>
      <option value="alphabet">ì•ŒíŒŒë²³ìœ¼ë¡œ ì„ íƒ</option>
    </select>

    <!-- ë²”ìœ„ ì„ íƒ -->
    <div id="testRangeSelect">
      <label>ë‹¨ì–´ ë²”ìœ„ ì„ íƒ:</label>
      <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
        <input type="number" id="testRangeStart" placeholder="ì‹œì‘" min="1" style="width: 80px;" value="1" />
        <span>~</span>
        <input type="number" id="testRangeEnd" placeholder="ë" min="1" style="width: 80px;" />
        <button onclick="setFullRangeTest()" style="width: auto; padding: 10px 15px; margin: 0;">ì „ì²´</button>
      </div>

      <label>ë¬¸ì œ ê°œìˆ˜ ì„ íƒ:</label>
      <select id="testCount">
        <option value="20">20ê°œ</option>
        <option value="30">30ê°œ</option>
        <option value="40">40ê°œ</option>
        <option value="50">50ê°œ</option>
      </select>
    </div>

    <!-- ì•ŒíŒŒë²³ ì„ íƒ -->
    <div id="testAlphabetSelect" style="display:none;">
      <label>ì‹œì‘ ì•ŒíŒŒë²³ ì„ íƒ:</label>
      <select id="testAlphabetFilter" onchange="updateTestAlphabetCount()" style="margin-top: 10px;">
        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        <option value="a">A</option>
        <option value="b">B</option>
        <option value="c">C</option>
        <option value="d">D</option>
        <option value="e">E</option>
        <option value="f">F</option>
        <option value="g">G</option>
        <option value="h">H</option>
        <option value="i">I</option>
        <option value="j">J</option>
        <option value="k">K</option>
        <option value="l">L</option>
        <option value="m">M</option>
        <option value="n">N</option>
        <option value="o">O</option>
        <option value="p">P</option>
        <option value="q">Q</option>
        <option value="r">R</option>
        <option value="s">S</option>
        <option value="t">T</option>
        <option value="u">U</option>
        <option value="v">V</option>
        <option value="w">W</option>
        <option value="x">X</option>
        <option value="y">Y</option>
        <option value="z">Z</option>
      </select>
      <div id="testAlphabetCount" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
    </div>

    <button onclick="startTest()">ì‹œí—˜ì§€ ìƒì„±</button>
  </div>

  <!-- í€´ì¦ˆ ì˜ì—­ -->
  <div id="quizArea" style="display:none;">
    <div class="progress" id="progress"></div>
    <div class="question" id="question"></div>
    <button onclick="speakWord()" id="speakBtn" style="background: #28a745; margin-bottom: 10px;">
      ğŸ”Š ë°œìŒ ë“£ê¸°
    </button>
    <button onclick="toggleBookmark()" id="bookmarkBtn" style="background: #ffc107; margin-bottom: 10px;">
      â­ ì¦ê²¨ì°¾ê¸° ì¶”ê°€
    </button>
    <input id="answerInput" placeholder="ì •ë‹µ ì…ë ¥..." onkeypress="handleKeyPress(event)" />
    <button onclick="checkAnswer()">ì œì¶œ</button>
    <div class="result" id="result"></div>
    <button onclick="nextQuestion()" id="nextBtn" style="display:none;">ë‹¤ìŒ ë¬¸ì œ</button>
  </div>

  <!-- ì‹œí—˜ì§€ ì˜ì—­ -->
  <div id="testArea" style="display:none;">
    <h3>ğŸ“ ì˜ì–´ ë‹¨ì–´ ì‹œí—˜ì§€</h3>
    <div id="testTableContainer"></div>
    <button onclick="submitTest()" id="submitTestBtn" style="margin-top: 20px;">ì±„ì í•˜ê¸°</button>
    <div id="scoreArea" style="display:none;">
      <div class="score-display" id="scoreDisplay"></div>
      <button onclick="resetTest()">ë‹¤ì‹œ í’€ê¸°</button>
      <button onclick="selectMode('test')">ìƒˆ ì‹œí—˜ì§€</button>
    </div>
  </div>
</div>

<script>
// -----------------------------
// ì˜ë‹¨ì–´ ëª©ë¡ (words.jsonì—ì„œ ë¶ˆëŸ¬ì˜´)
// -----------------------------
let WORDS = [];
let isLoading = true;

// JSON íŒŒì¼ì—ì„œ ë‹¨ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
fetch('words.json')
  .then(response => {
    if (!response.ok) {
      throw new Error('words.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    return response.json();
  })
  .then(data => {
    WORDS = data;
    isLoading = false;
    console.log(`${WORDS.length}ê°œì˜ ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
  })
  .catch(error => {
    isLoading = false;
    alert('ë‹¨ì–´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    console.error('Error loading words:', error);
  });

let quizList = [];
let currentQuiz = null;
let currentIndex = 0;
let totalCount = 0;
let testList = [];
let currentMode = 'quiz';
let bookmarkedWords = new Set();
let quizCorrectCount = 0;
let quizWrongCount = 0;
let isAnswerChecked = false;

// -----------------------------
// ì¦ê²¨ì°¾ê¸° ê´€ë¦¬
// -----------------------------
function loadBookmarks() {
  const saved = localStorage.getItem('bookmarkedWords');
  if (saved) {
    bookmarkedWords = new Set(JSON.parse(saved));
  }
}

function saveBookmarks() {
  localStorage.setItem('bookmarkedWords', JSON.stringify([...bookmarkedWords]));
}

function toggleBookmark() {
  if (!currentQuiz) return;
  
  const word = currentQuiz.originalWord;
  
  if (bookmarkedWords.has(word)) {
    bookmarkedWords.delete(word);
    alert(`"${word}" ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤.`);
  } else {
    bookmarkedWords.add(word);
    alert(`"${word}" ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!`);
  }
  
  saveBookmarks();
  updateBookmarkButton();
}

function updateBookmarkButton() {
  const btn = document.getElementById("bookmarkBtn");
  if (bookmarkedWords.has(currentQuiz.originalWord)) {
    btn.textContent = "â­ ì¦ê²¨ì°¾ê¸° ì œê±°";
    btn.style.background = "#ff9800";
  } else {
    btn.textContent = "â­ ì¦ê²¨ì°¾ê¸° ì¶”ê°€";
    btn.style.background = "#ffc107";
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
loadBookmarks();

// -----------------------------
// ì„ íƒ ëª¨ë“œ ë³€ê²½
// -----------------------------
function changeQuizSelectMode() {
  const mode = document.getElementById('quizSelectMode').value;
  if (mode === 'range') {
    document.getElementById('quizRangeSelect').style.display = 'block';
    document.getElementById('quizAlphabetSelect').style.display = 'none';
  } else {
    document.getElementById('quizRangeSelect').style.display = 'none';
    document.getElementById('quizAlphabetSelect').style.display = 'block';
    updateAlphabetCount();
  }
}

function changeTestSelectMode() {
  const mode = document.getElementById('testSelectMode').value;
  if (mode === 'range') {
    document.getElementById('testRangeSelect').style.display = 'block';
    document.getElementById('testAlphabetSelect').style.display = 'none';
  } else {
    document.getElementById('testRangeSelect').style.display = 'none';
    document.getElementById('testAlphabetSelect').style.display = 'block';
    updateTestAlphabetCount();
  }
}

function updateAlphabetCount() {
  const letter = document.getElementById('alphabetFilter').value;
  if (!letter) {
    document.getElementById('alphabetCount').textContent = '';
    return;
  }
  const count = WORDS.filter(w => w.word.toLowerCase().startsWith(letter)).length;
  document.getElementById('alphabetCount').textContent = `${letter.toUpperCase()}ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´: ${count}ê°œ`;
}

function updateTestAlphabetCount() {
  const letter = document.getElementById('testAlphabetFilter').value;
  if (!letter) {
    document.getElementById('testAlphabetCount').textContent = '';
    return;
  }
  const count = WORDS.filter(w => w.word.toLowerCase().startsWith(letter)).length;
  document.getElementById('testAlphabetCount').textContent = `${letter.toUpperCase()}ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´: ${count}ê°œ (ì „ì²´ ì¶œì œ)`;
}

// ì•ŒíŒŒë²³ í•„í„° ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', () => {
  const alphabetFilter = document.getElementById('alphabetFilter');
  if (alphabetFilter) {
    alphabetFilter.addEventListener('change', updateAlphabetCount);
  }
});

// -----------------------------
// ì „ì²´ ë²”ìœ„ ì„¤ì •
// -----------------------------
function setFullRange() {
  if (WORDS.length > 0) {
    document.getElementById('rangeEnd').value = WORDS.length;
  }
}

function setFullRangeTest() {
  if (WORDS.length > 0) {
    document.getElementById('testRangeEnd').value = WORDS.length;
  }
}

// ë°ì´í„° ë¡œë“œ í›„ ë ë²ˆí˜¸ ìë™ ì„¤ì •
window.addEventListener('load', () => {
  // 1ì´ˆ í›„ ì¬ì‹œë„ (ë°ì´í„° ë¡œë”© ëŒ€ê¸°)
  setTimeout(() => {
    if (WORDS.length > 0) {
      document.getElementById('rangeEnd').value = WORDS.length;
      document.getElementById('testRangeEnd').value = WORDS.length;
    }
  }, 1000);
});

// -----------------------------
// ëª¨ë“œ ì„ íƒ
// -----------------------------
function selectMode(mode) {
  currentMode = mode;
  
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
  document.getElementById('quizModeBtn').classList.remove('active');
  document.getElementById('testModeBtn').classList.remove('active');
  
  if (mode === 'quiz') {
    document.getElementById('quizModeBtn').classList.add('active');
    document.getElementById('quizSettings').style.display = 'block';
    document.getElementById('testSettings').style.display = 'none';
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('testArea').style.display = 'none';
  } else {
    document.getElementById('testModeBtn').classList.add('active');
    document.getElementById('quizSettings').style.display = 'none';
    document.getElementById('testSettings').style.display = 'block';
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('testArea').style.display = 'none';
  }
}

// -----------------------------
// í€´ì¦ˆ ì‹œì‘
// -----------------------------
function startQuiz() {
  // ë¡œë”© ì²´í¬
  if (isLoading) {
    alert('ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
    return;
  }

  const mode = document.getElementById("quizMode").value;
  const selectMode = document.getElementById("quizSelectMode").value;
  
  let selectedWords = [];
  
  if (selectMode === 'range') {
    // ë²”ìœ„ ì„ íƒ ëª¨ë“œ
    const count = Number(document.getElementById("quizCount").value);
    const rangeStart = Number(document.getElementById("rangeStart").value);
    const rangeEnd = Number(document.getElementById("rangeEnd").value);
    
    // ë²”ìœ„ ìœ íš¨ì„± ê²€ì‚¬
    if (!rangeStart || !rangeEnd) {
      alert('ë‹¨ì–´ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (rangeStart < 1 || rangeEnd > WORDS.length) {
      alert(`ë‹¨ì–´ ë²”ìœ„ëŠ” 1~${WORDS.length} ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
      return;
    }
    
    if (rangeStart > rangeEnd) {
      alert('ì‹œì‘ ë²ˆí˜¸ê°€ ë ë²ˆí˜¸ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ë²”ìœ„ ë‚´ ë‹¨ì–´ í•„í„°ë§
    const rangeWords = WORDS.slice(rangeStart - 1, rangeEnd);
    
    // ë‹¨ì–´ ìˆ˜ ì²´í¬
    if (rangeWords.length < count) {
      alert(`ì„ íƒí•œ ë²”ìœ„ì— ${rangeWords.length}ê°œì˜ ë‹¨ì–´ë§Œ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œ ê°œìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”.`);
      return;
    }
    
    selectedWords = [...rangeWords].sort(() => Math.random() - 0.5).slice(0, count);
    totalCount = count;
    
  } else {
    // ì•ŒíŒŒë²³ ì„ íƒ ëª¨ë“œ
    const letter = document.getElementById('alphabetFilter').value;
    
    if (!letter) {
      alert('ì•ŒíŒŒë²³ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // í•´ë‹¹ ì•ŒíŒŒë²³ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ í•„í„°ë§
    selectedWords = WORDS.filter(w => w.word.toLowerCase().startsWith(letter));
    
    if (selectedWords.length === 0) {
      alert(`${letter.toUpperCase()}ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }
    
    // ì„ê¸°
    selectedWords = [...selectedWords].sort(() => Math.random() - 0.5);
    totalCount = selectedWords.length;
  }

  // ë¦¬ìŠ¤íŠ¸ ìƒì„±
  quizList = selectedWords.map(item => {
    let isWordMode;
    
    // ë¬¸ì œ ìœ í˜•ì— ë”°ë¼ ì„¤ì •
    if (mode === "korean") {
      isWordMode = true;
    } else if (mode === "english") {
      isWordMode = false;
    } else {
      isWordMode = Math.random() < 0.5;
    }
    
    return {
      question: isWordMode ? item.word : item.meaning.join(", "),
      answerList: isWordMode ? item.meaning : [item.word],
      fullMeaning: item.meaning,
      originalWord: item.word,
      isWordMode: isWordMode
    };
  });

  currentIndex = 0;
  quizCorrectCount = 0;
  quizWrongCount = 0;
  document.getElementById("quizArea").style.display = "block";
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").style.display = "none";
  showQuestion();
}

// -----------------------------
// ë¬¸ì œ ì¶œë ¥
// -----------------------------
function showQuestion() {
  currentQuiz = quizList[currentIndex];
  isAnswerChecked = false;
  document.getElementById("progress").textContent = 
    `ì§„í–‰: ${currentIndex + 1} / ${totalCount} | ì •ë‹µ: ${quizCorrectCount}ê°œ | ì˜¤ë‹µ: ${quizWrongCount}ê°œ`;
  document.getElementById("question").textContent =
    `ë¬¸ì œ ${currentIndex + 1}: ${currentQuiz.question}`;
  document.getElementById("answerInput").value = "";
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("answerInput").focus();
  
  // ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  updateBookmarkButton();
}

// -----------------------------
// ë‹µì•ˆ ì²´í¬
// -----------------------------
function checkAnswer() {
  // ì´ë¯¸ ì²´í¬í•œ ê²½ìš° ë¬´ì‹œ
  if (isAnswerChecked) {
    return;
  }

  const user = document.getElementById("answerInput").value.trim();
  if (!user) {
    alert("ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  const result = document.getElementById("result");

  // ì •ë‹µ ì¡°ê±´: í•­ìƒ ì™„ì „ì¼ì¹˜ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆ í•¨)
  const isCorrect = currentQuiz.answerList.some(ans =>
    ans.toLowerCase() === user.toLowerCase()
  );

  // ë§ì¶˜ ì •ë‹µ
  const matchedMeaning = currentQuiz.answerList.filter(ans =>
    ans.toLowerCase() === user.toLowerCase()
  );

  // ì „ì²´ ëœ» ì¤‘ ë‚˜ë¨¸ì§€
  const otherMeanings = currentQuiz.fullMeaning.filter(
    m => !matchedMeaning.some(matched => matched.toLowerCase() === m.toLowerCase())
  );

  if (isCorrect) {
    quizCorrectCount++;
    result.innerHTML =
      `â­• <b>ì •ë‹µì…ë‹ˆë‹¤!</b><br>
      ì…ë ¥í•œ ë‹µ: ${user}<br>
      ë§ëŠ” ì •ë‹µ: ${matchedMeaning.join(", ")}<br>
      ${otherMeanings.length > 0 ? `ë‹¤ë¥¸ ëœ»ë“¤: ${otherMeanings.join(", ")}` : ''}`;
  } else {
    quizWrongCount++;
    result.innerHTML =
      `âŒ <b>ì˜¤ë‹µì…ë‹ˆë‹¤.</b><br>
      ì…ë ¥í•œ ë‹µ: ${user}<br>
      ì •ë‹µ: ${currentQuiz.answerList.join(", ")}<br>
      ì „ì²´ ëœ»: ${currentQuiz.fullMeaning.join(", ")}`;
  }

  // ë‹µë³€ ì²´í¬ ì™„ë£Œ í‘œì‹œ
  isAnswerChecked = true;

  // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì •ë‹µ/ì˜¤ë‹µ ìˆ˜ ë°˜ì˜)
  document.getElementById("progress").textContent = 
    `ì§„í–‰: ${currentIndex + 1} / ${totalCount} | ì •ë‹µ: ${quizCorrectCount}ê°œ | ì˜¤ë‹µ: ${quizWrongCount}ê°œ`;

  // ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
  document.getElementById("nextBtn").style.display = "block";
}

// -----------------------------
// ë‹¤ìŒ ë¬¸ì œ
// -----------------------------
function nextQuestion() {
  currentIndex++;
  if (currentIndex >= quizList.length) {
    const totalScore = Math.round((quizCorrectCount / totalCount) * 100);
    alert(`í€´ì¦ˆ ì™„ë£Œ!\n\nì´ ${totalCount}ë¬¸ì œ ì¤‘\nì •ë‹µ: ${quizCorrectCount}ê°œ\nì˜¤ë‹µ: ${quizWrongCount}ê°œ\n\nì ìˆ˜: ${totalScore}ì \n\nìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!`);
    document.getElementById("quizArea").style.display = "none";
    return;
  }
  showQuestion();
}

// -----------------------------
// ìŒì„± ë°œìŒ (ì˜ì–´ ë‹¨ì–´ë§Œ)
// -----------------------------
function speakWord() {
  if (!currentQuiz) return;
  
  const textToSpeak = currentQuiz.originalWord;
  
  // ìŒì„± í•©ì„±
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'en-US';
  utterance.rate = 0.8;
  
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utterance);
}

// -----------------------------
// ì‹œí—˜ì§€ ëª¨ë“œ ì‹œì‘
// -----------------------------
function startTest() {
  if (isLoading) {
    alert('ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
    return;
  }

  const mode = document.getElementById("testMode").value;
  const selectMode = document.getElementById("testSelectMode").value;
  
  let selectedWords = [];
  
  if (selectMode === 'range') {
    // ë²”ìœ„ ì„ íƒ ëª¨ë“œ
    const count = Number(document.getElementById("testCount").value);
    const rangeStart = Number(document.getElementById("testRangeStart").value);
    const rangeEnd = Number(document.getElementById("testRangeEnd").value);
    
    // ë²”ìœ„ ìœ íš¨ì„± ê²€ì‚¬
    if (!rangeStart || !rangeEnd) {
      alert('ë‹¨ì–´ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (rangeStart < 1 || rangeEnd > WORDS.length) {
      alert(`ë‹¨ì–´ ë²”ìœ„ëŠ” 1~${WORDS.length} ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
      return;
    }
    
    if (rangeStart > rangeEnd) {
      alert('ì‹œì‘ ë²ˆí˜¸ê°€ ë ë²ˆí˜¸ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ë²”ìœ„ ë‚´ ë‹¨ì–´ í•„í„°ë§
    const rangeWords = WORDS.slice(rangeStart - 1, rangeEnd);
    
    // ë‹¨ì–´ ìˆ˜ ì²´í¬
    if (rangeWords.length < count) {
      alert(`ì„ íƒí•œ ë²”ìœ„ì— ${rangeWords.length}ê°œì˜ ë‹¨ì–´ë§Œ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œ ê°œìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”.`);
      return;
    }
    
    selectedWords = [...rangeWords].sort(() => Math.random() - 0.5).slice(0, count);
    
  } else {
    // ì•ŒíŒŒë²³ ì„ íƒ ëª¨ë“œ
    const letter = document.getElementById('testAlphabetFilter').value;
    
    if (!letter) {
      alert('ì•ŒíŒŒë²³ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // í•´ë‹¹ ì•ŒíŒŒë²³ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ í•„í„°ë§
    selectedWords = WORDS.filter(w => w.word.toLowerCase().startsWith(letter));
    
    if (selectedWords.length === 0) {
      alert(`${letter.toUpperCase()}ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }
    
    // ì„ê¸°
    selectedWords = [...selectedWords].sort(() => Math.random() - 0.5);
  }

  // ì‹œí—˜ì§€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
  testList = selectedWords.map((item, index) => {
    let isWordMode;
    
    if (mode === "korean") {
      isWordMode = true;
    } else if (mode === "english") {
      isWordMode = false;
    } else {
      isWordMode = Math.random() < 0.5;
    }
    
    return {
      id: index,
      question: isWordMode ? item.word : item.meaning.join(", "),
      correctAnswer: isWordMode ? item.meaning : [item.word],
      fullMeaning: item.meaning,
      originalWord: item.word,
      isWordMode: isWordMode,
      userAnswer: ""
    };
  });

  createTestTable();
  
  document.getElementById('testArea').style.display = 'block';
  document.getElementById('scoreArea').style.display = 'none';
  document.getElementById('submitTestBtn').style.display = 'block';
}

// -----------------------------
// ì‹œí—˜ì§€ í…Œì´ë¸” ìƒì„±
// -----------------------------
function createTestTable() {
  let html = '<table class="test-table">';
  html += '<thead><tr><th style="width:50px;">ë²ˆí˜¸</th><th>ë¬¸ì œ</th><th>ë‹µì•ˆ</th><th style="width:80px;">ì¦ê²¨ì°¾ê¸°</th></tr></thead>';
  html += '<tbody>';
  
  testList.forEach((item, index) => {
    const isBookmarked = bookmarkedWords.has(item.originalWord);
    const bookmarkClass = isBookmarked ? 'active' : '';
    const bookmarkText = isBookmarked ? 'â­' : 'â˜†';
    
    html += `
      <tr>
        <td>${index + 1}</td>
        <td>${item.question}</td>
        <td>
          <input type="text" 
                 id="answer_${item.id}" 
                 placeholder="ë‹µ ì…ë ¥"
                 autocomplete="off" />
        </td>
        <td style="text-align: center;">
          <button class="test-bookmark-btn ${bookmarkClass}" 
                  onclick="toggleTestBookmark('${item.originalWord}', ${item.id})"
                  id="bookmark_${item.id}">
            ${bookmarkText}
          </button>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  document.getElementById('testTableContainer').innerHTML = html;
}

// -----------------------------
// ì‹œí—˜ì§€ì—ì„œ ì¦ê²¨ì°¾ê¸° í† ê¸€
// -----------------------------
function toggleTestBookmark(word, itemId) {
  if (bookmarkedWords.has(word)) {
    bookmarkedWords.delete(word);
  } else {
    bookmarkedWords.add(word);
  }
  
  saveBookmarks();
  
  // ë²„íŠ¼ ì—…ë°ì´íŠ¸
  const btn = document.getElementById(`bookmark_${itemId}`);
  if (bookmarkedWords.has(word)) {
    btn.classList.add('active');
    btn.textContent = 'â­';
  } else {
    btn.classList.remove('active');
    btn.textContent = 'â˜†';
  }
}

// -----------------------------
// ì‹œí—˜ì§€ ì±„ì 
// -----------------------------
function submitTest() {
  let correctCount = 0;
  
  testList.forEach(item => {
    const inputEl = document.getElementById(`answer_${item.id}`);
    const userAnswer = inputEl.value.trim();
    item.userAnswer = userAnswer;
    
    // ì •ë‹µ ì²´í¬: í•­ìƒ ì™„ì „ì¼ì¹˜ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆ í•¨)
    const isCorrect = item.correctAnswer.some(ans =>
      ans.toLowerCase() === userAnswer.toLowerCase()
    );
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    if (userAnswer === "") {
      inputEl.classList.remove('correct', 'wrong');
    } else if (isCorrect) {
      inputEl.classList.add('correct');
      inputEl.classList.remove('wrong');
      correctCount++;
    } else {
      inputEl.classList.add('wrong');
      inputEl.classList.remove('correct');
    }
    
    // ì •ë‹µ í‘œì‹œ
    if (!isCorrect && userAnswer !== "") {
      const correctText = item.correctAnswer.join(", ");
      if (!inputEl.nextElementSibling || !inputEl.nextElementSibling.classList.contains('answer-key')) {
        const answerKey = document.createElement('div');
        answerKey.className = 'answer-key';
        answerKey.textContent = `ì •ë‹µ: ${correctText}`;
        inputEl.parentElement.appendChild(answerKey);
      }
    }
  });
  
  const score = Math.round((correctCount / testList.length) * 100);
  document.getElementById('scoreDisplay').innerHTML = `
    <div>ì´ ${testList.length}ë¬¸ì œ ì¤‘ ${correctCount}ê°œ ì •ë‹µ</div>
    <div style="font-size: 36px; margin-top: 10px;">${score}ì </div>
  `;
  
  document.getElementById('scoreArea').style.display = 'block';
  document.getElementById('submitTestBtn').style.display = 'none';
  
  document.getElementById('scoreDisplay').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// -----------------------------
// ì‹œí—˜ì§€ ì´ˆê¸°í™”
// -----------------------------
function resetTest() {
  testList.forEach(item => {
    const inputEl = document.getElementById(`answer_${item.id}`);
    if (inputEl) {
      inputEl.value = "";
      inputEl.classList.remove('correct', 'wrong');
      
      const answerKey = inputEl.parentElement.querySelector('.answer-key');
      if (answerKey) {
        answerKey.remove();
      }
    }
  });
  
  document.getElementById('scoreArea').style.display = 'none';
  document.getElementById('submitTestBtn').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// -----------------------------
// ì—”í„°í‚¤ë¡œ ì œì¶œ
// -----------------------------
function handleKeyPress(event) {
  if (event.key === "Enter") {
    const nextBtn = document.getElementById("nextBtn");
    if (nextBtn.style.display === "none") {
      checkAnswer();
    } else {
      nextQuestion();
    }
  }
}
</script>
</body>
</html>